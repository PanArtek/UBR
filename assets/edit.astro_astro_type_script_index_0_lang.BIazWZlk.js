class d{constructor(){this.features=[],this.images=[],this.currentProjectId=null,this.isEditMode=!1,this.init()}async init(){if(!this.isLoggedIn()){this.showAuthError();return}document.getElementById("mainContent").style.display="block";const t=new URLSearchParams(window.location.search).get("id");t&&(this.isEditMode=!0,this.currentProjectId=t,await this.loadProject(t),document.getElementById("pageTitle").textContent="✏️ Edytuj projekt"),this.setupEventListeners()}isLoggedIn(){const e=sessionStorage.getItem("ubr_admin_logged_in"),t=sessionStorage.getItem("ubr_admin_login_time");if(!e||!t)return!1;const s=Date.now()-parseInt(t),a=8*60*60*1e3;return s<=a}showAuthError(){document.getElementById("authCheck").classList.remove("hidden")}async loadProject(e){try{const s=(await(await fetch("/UBR/data/projects.json")).json()).projects.find(a=>a.id===e);s?this.populateForm(s):(this.showNotification("Projekt nie został znaleziony","error"),setTimeout(()=>this.goBack(),2e3))}catch(t){console.error("Error loading project:",t),this.showNotification("Błąd podczas ładowania projektu","error")}}populateForm(e){document.getElementById("projectId").value=e.id,document.getElementById("title").value=e.title,document.getElementById("category").value=e.category,document.getElementById("location").value=e.location,document.getElementById("area").value=e.area||"",document.getElementById("year").value=e.year||"",document.getElementById("description").value=e.description,document.getElementById("scope").value=e.scope||"",document.getElementById("isVisible").checked=e.isVisible,this.features=e.features||[],this.renderFeatures(),e.images&&this.showExistingImages(e.images)}showExistingImages(e){const t=document.getElementById("imagePreview"),o=e.map(s=>`
        <div class="image-preview-item">
          <img src="${s.url}" alt="${s.caption||"Zdjęcie"}" onerror="this.src='/UBR/images/placeholder.svg'" />
          <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 text-white text-xs p-2">
            <p class="truncate">${s.caption||"Istniejące zdjęcie"}</p>
          </div>
        </div>
      `).join("");t.innerHTML=o}setupEventListeners(){document.getElementById("projectForm").addEventListener("submit",a=>{a.preventDefault(),this.handleSubmit()}),document.getElementById("featuresInput").addEventListener("keypress",a=>{a.key==="Enter"&&(a.preventDefault(),this.addFeature())});const o=document.getElementById("imageUpload");o.addEventListener("change",a=>{this.handleImageUpload(a.target.files)});const s=o.parentElement;["dragenter","dragover","dragleave","drop"].forEach(a=>{s.addEventListener(a,this.preventDefaults,!1)}),["dragenter","dragover"].forEach(a=>{s.addEventListener(a,()=>s.classList.add("drag-over"),!1)}),["dragleave","drop"].forEach(a=>{s.addEventListener(a,()=>s.classList.remove("drag-over"),!1)}),s.addEventListener("drop",a=>{const n=a.dataTransfer.files;this.handleImageUpload(n)},!1)}preventDefaults(e){e.preventDefault(),e.stopPropagation()}addFeature(){const e=document.getElementById("featuresInput"),t=e.value.trim();t&&!this.features.includes(t)&&(this.features.push(t),this.renderFeatures(),e.value="")}removeFeature(e){this.features.splice(e,1),this.renderFeatures()}renderFeatures(){const e=document.getElementById("featuresList");e.innerHTML=this.features.map((t,o)=>`
        <span class="feature-tag">
          ${t}
          <button type="button" onclick="projectEditor.removeFeature(${o})" class="hover:bg-red-200 rounded-full w-5 h-5 flex items-center justify-center">
            ×
          </button>
        </span>
      `).join("")}handleImageUpload(e){const t=document.getElementById("imagePreview");Array.from(e).forEach((o,s)=>{if(o.type.startsWith("image/")){const a=new FileReader;a.onload=n=>{const i=document.createElement("div");i.className="image-preview-item",i.innerHTML=`
              <img src="${n.target.result}" alt="Preview" />
              <button type="button" onclick="this.parentElement.remove()" class="remove-btn">×</button>
              <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 text-white text-xs p-2">
                <input type="text" placeholder="Opis zdjęcia..." 
                       class="w-full bg-transparent border-none text-white placeholder-gray-300 text-xs" />
              </div>
            `,t.appendChild(i)},a.readAsDataURL(o),this.images.push(o)}})}async handleSubmit(){const e=new FormData(document.getElementById("projectForm"));this.isEditMode?this.currentProjectId:this.generateId(),e.get("title"),e.get("category"),e.get("location"),e.get("area"),e.get("year")||new Date().getFullYear().toString(),e.get("description"),e.get("scope"),this.features,e.get("isVisible"),this.isEditMode||new Date().toISOString(),this.isEditMode||Date.now();const t=document.querySelector('button[type="submit"]'),o=t.textContent;t.textContent="⏳ Zapisywanie...",t.disabled=!0;try{await this.simulateApiCall(),this.showNotification(this.isEditMode?"Projekt został zaktualizowany!":"Projekt został dodany!","success"),setTimeout(()=>{window.location.href="/UBR/admin/projects/"},1500)}catch(s){console.error("Error saving project:",s),this.showNotification("Błąd podczas zapisywania projektu","error"),t.textContent=o,t.disabled=!1}}generateId(){return"proj-"+Date.now().toString(36)+Math.random().toString(36).substr(2,5)}simulateApiCall(){return new Promise(e=>setTimeout(e,1500))}showNotification(e,t="info"){const o=document.createElement("div");o.className=`fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg text-white transform transition-all duration-300 translate-x-full ${t==="success"?"bg-green-600":t==="error"?"bg-red-600":"bg-blue-600"}`,o.textContent=e,document.body.appendChild(o),setTimeout(()=>{o.classList.remove("translate-x-full")},100),setTimeout(()=>{o.classList.add("translate-x-full"),setTimeout(()=>{document.body.contains(o)&&document.body.removeChild(o)},300)},3e3)}goBack(){confirm("Czy na pewno chcesz wyjść? Niezapisane zmiany zostaną utracone.")&&(window.location.href="/UBR/admin/projects/")}}window.goBack=()=>{window.projectEditor.goBack()};let r;document.addEventListener("DOMContentLoaded",()=>{r=new d,window.projectEditor=r});

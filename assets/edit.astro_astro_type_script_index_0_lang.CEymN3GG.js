class c{constructor(){this.features=[],this.images=[],this.currentProjectId=null,this.isEditMode=!1,this.init()}async init(){if(!this.isLoggedIn()){this.showAuthError();return}document.getElementById("mainContent").style.display="block";const t=new URLSearchParams(window.location.search).get("id");t&&(this.isEditMode=!0,this.currentProjectId=t,await this.loadProject(t),document.getElementById("pageTitle").textContent="✏️ Edytuj projekt"),this.setupEventListeners()}isLoggedIn(){const e=sessionStorage.getItem("ubr_admin_logged_in"),t=sessionStorage.getItem("ubr_admin_login_time");if(!e||!t)return!1;const o=Date.now()-parseInt(t),a=8*60*60*1e3;return o<=a}showAuthError(){document.getElementById("authCheck").classList.remove("hidden")}async loadProject(e){try{const o=(await(await fetch("/UBR/data/projects.json")).json()).projects.find(a=>a.id===e);o?this.populateForm(o):(this.showNotification("Projekt nie został znaleziony","error"),setTimeout(()=>this.goBack(),2e3))}catch(t){console.error("Error loading project:",t),this.showNotification("Błąd podczas ładowania projektu","error")}}populateForm(e){document.getElementById("projectId").value=e.id,document.getElementById("title").value=e.title,document.getElementById("category").value=e.category,document.getElementById("location").value=e.location,document.getElementById("area").value=e.area||"",document.getElementById("year").value=e.year||"",document.getElementById("description").value=e.description,document.getElementById("scope").value=e.scope||"",document.getElementById("isVisible").checked=e.isVisible,this.features=e.features||[],this.renderFeatures(),e.images&&this.showExistingImages(e.images)}showExistingImages(e){const t=document.getElementById("imagePreview"),r=e.map(o=>`
        <div class="image-preview-item">
          <img src="${o.url}" alt="${o.caption||"Zdjęcie"}" onerror="this.src='/UBR/images/placeholder.svg'" />
          <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 text-white text-xs p-2">
            <p class="truncate">${o.caption||"Istniejące zdjęcie"}</p>
          </div>
        </div>
      `).join("");t.innerHTML=r}setupEventListeners(){document.getElementById("projectForm").addEventListener("submit",a=>{a.preventDefault(),this.handleSubmit()}),document.getElementById("featuresInput").addEventListener("keypress",a=>{a.key==="Enter"&&(a.preventDefault(),this.addFeature())});const r=document.getElementById("imageUpload");r.addEventListener("change",a=>{this.handleImageUpload(a.target.files)});const o=r.parentElement;["dragenter","dragover","dragleave","drop"].forEach(a=>{o.addEventListener(a,this.preventDefaults,!1)}),["dragenter","dragover"].forEach(a=>{o.addEventListener(a,()=>o.classList.add("drag-over"),!1)}),["dragleave","drop"].forEach(a=>{o.addEventListener(a,()=>o.classList.remove("drag-over"),!1)}),o.addEventListener("drop",a=>{const s=a.dataTransfer.files;this.handleImageUpload(s)},!1)}preventDefaults(e){e.preventDefault(),e.stopPropagation()}addFeature(){const e=document.getElementById("featuresInput"),t=e.value.trim();t&&!this.features.includes(t)&&(this.features.push(t),this.renderFeatures(),e.value="")}removeFeature(e){this.features.splice(e,1),this.renderFeatures()}renderFeatures(){const e=document.getElementById("featuresList");e.innerHTML=this.features.map((t,r)=>`
        <span class="feature-tag">
          ${t}
          <button type="button" onclick="projectEditor.removeFeature(${r})" class="hover:bg-red-200 rounded-full w-5 h-5 flex items-center justify-center">
            ×
          </button>
        </span>
      `).join("")}handleImageUpload(e){const t=document.getElementById("imagePreview");Array.from(e).forEach((r,o)=>{if(r.type.startsWith("image/")){const a=new FileReader;a.onload=s=>{const n=document.createElement("div");n.className="image-preview-item",n.innerHTML=`
              <img src="${s.target.result}" alt="Preview" />
              <button type="button" onclick="this.parentElement.remove()" class="remove-btn">×</button>
              <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 text-white text-xs p-2">
                <input type="text" placeholder="Opis zdjęcia..." 
                       class="w-full bg-transparent border-none text-white placeholder-gray-300 text-xs" />
              </div>
            `,t.appendChild(n)},a.readAsDataURL(r),this.images.push(r)}})}async handleSubmit(){const e=new FormData(document.getElementById("projectForm")),t=document.querySelector('button[type="submit"]'),r=t.textContent;t.textContent="⏳ Zapisywanie...",t.disabled=!0;try{let o=[];this.images.length>0&&(o=await this.uploadImages());const a={id:this.isEditMode?this.currentProjectId:this.generateId(),title:e.get("title"),category:e.get("category"),location:e.get("location"),area:e.get("area"),year:e.get("year")||new Date().getFullYear().toString(),description:e.get("description"),scope:e.get("scope"),features:this.features,isVisible:e.get("isVisible")==="on",createdAt:this.isEditMode?void 0:new Date().toISOString(),order:this.isEditMode?void 0:Date.now(),images:o.length>0?o:this.collectImageData()};let s=!1;try{s=await this.saveProjectToAPI(a)}catch(n){console.warn("PHP API not available, falling back to localStorage:",n)}s||await this.saveProjectToLocalStorage(a),this.showNotification(this.isEditMode?"Projekt został zaktualizowany!":"Projekt został dodany!","success"),setTimeout(()=>{window.location.href="/UBR/admin/projects/"},1500)}catch(o){console.error("Error saving project:",o),this.showNotification("Błąd podczas zapisywania projektu","error"),t.textContent=r,t.disabled=!1}}generateId(){return"proj-"+Date.now().toString(36)+Math.random().toString(36).substr(2,5)}saveProjectToLocalStorage(e){try{const t=localStorage.getItem("ubr_projects");let r=t?JSON.parse(t):[];if(e.images=this.collectImageData(),this.isEditMode){const o=r.findIndex(a=>a.id===e.id);o>=0?r[o]={...r[o],...e}:r.push(e)}else r.push(e);return localStorage.setItem("ubr_projects",JSON.stringify(r)),console.log("Project saved to localStorage:",e),Promise.resolve()}catch(t){return console.error("Error saving to localStorage:",t),Promise.reject(t)}}collectImageData(){const e=document.getElementById("imagePreview");if(!e)return[];const t=[];return e.querySelectorAll("img").forEach((o,a)=>{const s=o.parentElement.querySelector('input[type="text"]');t.push({id:`img-${Date.now()}-${a}`,url:o.src,caption:s?s.value:"",isMain:a===0,order:a+1,filename:`local_image_${a+1}.jpg`})}),t}async uploadImages(){if(this.images.length===0)return[];const e=new FormData;this.images.forEach((o,a)=>{e.append("photos[]",o)});const t=document.getElementById("category").value,r=document.getElementById("title").value;e.append("category",t),e.append("project_name",r);try{const o=await fetch("/api/upload.php",{method:"POST",body:e});if(o.ok){const a=await o.json();if(a.success)return console.log("Images uploaded successfully:",a.files),a.files.map((s,n)=>({id:`img-${Date.now()}-${n}`,filename:s.filename,url:s.url,caption:`${r} - zdjęcie ${n+1}`,isMain:n===0,order:n+1}));throw new Error("Upload failed: "+(a.error||"Unknown error"))}else throw new Error("Upload request failed")}catch(o){throw console.error("Image upload error:",o),o}}async saveProjectToAPI(e){try{const t=this.isEditMode?"PUT":"POST",r=await fetch("/api/projects.php",{method:t,headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(r.ok){const o=await r.json();if(o.success)return console.log("Project saved via API:",o.project),!0;throw new Error("API save failed: "+(o.error||"Unknown error"))}else throw new Error("API request failed")}catch(t){throw console.error("API save error:",t),t}}showNotification(e,t="info"){const r=document.createElement("div");r.className=`fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg text-white transform transition-all duration-300 translate-x-full ${t==="success"?"bg-green-600":t==="error"?"bg-red-600":"bg-blue-600"}`,r.textContent=e,document.body.appendChild(r),setTimeout(()=>{r.classList.remove("translate-x-full")},100),setTimeout(()=>{r.classList.add("translate-x-full"),setTimeout(()=>{document.body.contains(r)&&document.body.removeChild(r)},300)},3e3)}goBack(){confirm("Czy na pewno chcesz wyjść? Niezapisane zmiany zostaną utracone.")&&(window.location.href="/UBR/admin/projects/")}}window.goBack=()=>{window.projectEditor.goBack()};let i;document.addEventListener("DOMContentLoaded",()=>{i=new c,window.projectEditor=i});

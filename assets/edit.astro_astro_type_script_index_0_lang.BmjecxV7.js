class d{constructor(){this.features=[],this.images=[],this.currentProjectId=null,this.isEditMode=!1,this.init()}async init(){if(!this.isLoggedIn()){this.showAuthError();return}document.getElementById("mainContent").style.display="block";const t=new URLSearchParams(window.location.search).get("id");t&&(this.isEditMode=!0,this.currentProjectId=t,await this.loadProject(t),document.getElementById("pageTitle").textContent="✏️ Edytuj projekt"),this.setupEventListeners()}isLoggedIn(){const e=sessionStorage.getItem("ubr_admin_logged_in"),t=sessionStorage.getItem("ubr_admin_login_time");if(!e||!t)return!1;const a=Date.now()-parseInt(t),s=8*60*60*1e3;return a<=s}showAuthError(){document.getElementById("authCheck").classList.remove("hidden")}async loadProject(e){try{const a=(await(await fetch("/UBR/data/projects.json")).json()).projects.find(s=>s.id===e);a?this.populateForm(a):(this.showNotification("Projekt nie został znaleziony","error"),setTimeout(()=>this.goBack(),2e3))}catch(t){console.error("Error loading project:",t),this.showNotification("Błąd podczas ładowania projektu","error")}}populateForm(e){document.getElementById("projectId").value=e.id,document.getElementById("title").value=e.title,document.getElementById("category").value=e.category,document.getElementById("location").value=e.location,document.getElementById("area").value=e.area||"",document.getElementById("year").value=e.year||"",document.getElementById("description").value=e.description,document.getElementById("scope").value=e.scope||"",document.getElementById("isVisible").checked=e.isVisible,this.features=e.features||[],this.renderFeatures(),e.images&&this.showExistingImages(e.images)}showExistingImages(e){const t=document.getElementById("imagePreview"),o=e.map(a=>`
        <div class="image-preview-item">
          <img src="${a.url}" alt="${a.caption||"Zdjęcie"}" onerror="this.src='/UBR/images/placeholder.svg'" />
          <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 text-white text-xs p-2">
            <p class="truncate">${a.caption||"Istniejące zdjęcie"}</p>
          </div>
        </div>
      `).join("");t.innerHTML=o}setupEventListeners(){document.getElementById("projectForm").addEventListener("submit",s=>{s.preventDefault(),this.handleSubmit()}),document.getElementById("featuresInput").addEventListener("keypress",s=>{s.key==="Enter"&&(s.preventDefault(),this.addFeature())});const o=document.getElementById("imageUpload");o.addEventListener("change",s=>{this.handleImageUpload(s.target.files)});const a=o.parentElement;["dragenter","dragover","dragleave","drop"].forEach(s=>{a.addEventListener(s,this.preventDefaults,!1)}),["dragenter","dragover"].forEach(s=>{a.addEventListener(s,()=>a.classList.add("drag-over"),!1)}),["dragleave","drop"].forEach(s=>{a.addEventListener(s,()=>a.classList.remove("drag-over"),!1)}),a.addEventListener("drop",s=>{const n=s.dataTransfer.files;this.handleImageUpload(n)},!1)}preventDefaults(e){e.preventDefault(),e.stopPropagation()}addFeature(){const e=document.getElementById("featuresInput"),t=e.value.trim();t&&!this.features.includes(t)&&(this.features.push(t),this.renderFeatures(),e.value="")}removeFeature(e){this.features.splice(e,1),this.renderFeatures()}renderFeatures(){const e=document.getElementById("featuresList");e.innerHTML=this.features.map((t,o)=>`
        <span class="feature-tag">
          ${t}
          <button type="button" onclick="projectEditor.removeFeature(${o})" class="hover:bg-red-200 rounded-full w-5 h-5 flex items-center justify-center">
            ×
          </button>
        </span>
      `).join("")}handleImageUpload(e){const t=document.getElementById("imagePreview");Array.from(e).forEach((o,a)=>{if(o.type.startsWith("image/")){const s=new FileReader;s.onload=n=>{const r=document.createElement("div");r.className="image-preview-item",r.innerHTML=`
              <img src="${n.target.result}" alt="Preview" />
              <button type="button" onclick="this.parentElement.remove()" class="remove-btn">×</button>
              <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 text-white text-xs p-2">
                <input type="text" placeholder="Opis zdjęcia..." 
                       class="w-full bg-transparent border-none text-white placeholder-gray-300 text-xs" />
              </div>
            `,t.appendChild(r)},s.readAsDataURL(o),this.images.push(o)}})}async handleSubmit(){const e=new FormData(document.getElementById("projectForm")),t={id:this.isEditMode?this.currentProjectId:this.generateId(),title:e.get("title"),category:e.get("category"),location:e.get("location"),area:e.get("area"),year:e.get("year")||new Date().getFullYear().toString(),description:e.get("description"),scope:e.get("scope"),features:this.features,isVisible:e.get("isVisible")==="on",createdAt:this.isEditMode?void 0:new Date().toISOString(),order:this.isEditMode?void 0:Date.now()},o=document.querySelector('button[type="submit"]'),a=o.textContent;o.textContent="⏳ Zapisywanie...",o.disabled=!0;try{this.saveProjectToLocalStorage(t),this.showNotification(this.isEditMode?"Projekt został zaktualizowany!":"Projekt został dodany!","success"),setTimeout(()=>{window.location.href="/UBR/admin/projects/"},1500)}catch(s){console.error("Error saving project:",s),this.showNotification("Błąd podczas zapisywania projektu","error"),o.textContent=a,o.disabled=!1}}generateId(){return"proj-"+Date.now().toString(36)+Math.random().toString(36).substr(2,5)}saveProjectToLocalStorage(e){try{const t=localStorage.getItem("ubr_projects");let o=t?JSON.parse(t):[];if(e.images=this.collectImageData(),this.isEditMode){const a=o.findIndex(s=>s.id===e.id);a>=0?o[a]={...o[a],...e}:o.push(e)}else o.push(e);return localStorage.setItem("ubr_projects",JSON.stringify(o)),console.log("Project saved to localStorage:",e),Promise.resolve()}catch(t){return console.error("Error saving to localStorage:",t),Promise.reject(t)}}collectImageData(){const e=document.getElementById("imagePreview");if(!e)return[];const t=[];return e.querySelectorAll("img").forEach((a,s)=>{const n=a.parentElement.querySelector('input[type="text"]');t.push({id:`img-${Date.now()}-${s}`,url:a.src,caption:n?n.value:"",isMain:s===0,order:s+1,filename:`local_image_${s+1}.jpg`})}),t}showNotification(e,t="info"){const o=document.createElement("div");o.className=`fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg text-white transform transition-all duration-300 translate-x-full ${t==="success"?"bg-green-600":t==="error"?"bg-red-600":"bg-blue-600"}`,o.textContent=e,document.body.appendChild(o),setTimeout(()=>{o.classList.remove("translate-x-full")},100),setTimeout(()=>{o.classList.add("translate-x-full"),setTimeout(()=>{document.body.contains(o)&&document.body.removeChild(o)},300)},3e3)}goBack(){confirm("Czy na pewno chcesz wyjść? Niezapisane zmiany zostaną utracone.")&&(window.location.href="/UBR/admin/projects/")}}window.goBack=()=>{window.projectEditor.goBack()};let i;document.addEventListener("DOMContentLoaded",()=>{i=new d,window.projectEditor=i});
